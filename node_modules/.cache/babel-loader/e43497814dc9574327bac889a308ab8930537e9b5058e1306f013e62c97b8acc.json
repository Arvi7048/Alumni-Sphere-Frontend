{"ast":null,"code":"\"use client\";import _objectSpread from\"C:/Users/arvin/OneDrive/Desktop/project2/alumni-verse/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import{useState,useEffect}from\"react\";import{useAuth}from\"../context/AuthContext\";import{PlusIcon,HeartIcon,ChatBubbleLeftIcon,PhotoIcon}from\"@heroicons/react/24/outline\";import{HeartIcon as HeartIconSolid}from\"@heroicons/react/24/solid\";import api from\"../utils/api\";import Modal from\"../components/Modal\";import LoadingSpinner from\"../components/LoadingSpinner\";import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const Stories=()=>{const{user}=useAuth();const[stories,setStories]=useState([]);const[loading,setLoading]=useState(true);const[showCreateModal,setShowCreateModal]=useState(false);const[creating,setCreating]=useState(false);const[uploading,setUploading]=useState(false);const[error,setError]=useState(\"\");const[storyForm,setStoryForm]=useState({title:\"\",content:\"\",image:null});useEffect(()=>{fetchStories();},[]);const fetchStories=async()=>{try{const res=await api.get(\"/stories\");if(res.success){// Defensive: handle both array and object response\nif(Array.isArray(res.data)){setStories(res.data);}else if(Array.isArray(res.data.stories)){setStories(res.data.stories);}else{setStories([]);}}else{throw new Error(res.error||'Failed to fetch stories');}}catch(error){console.error(\"Failed to fetch stories:\",error);}finally{setLoading(false);}};const handleStoryFormChange=e=>{if(e.target.name===\"image\"){setStoryForm(_objectSpread(_objectSpread({},storyForm),{},{image:e.target.files[0]}));}else{setStoryForm(_objectSpread(_objectSpread({},storyForm),{},{[e.target.name]:e.target.value}));}};const handleCreateStory=async e=>{e.preventDefault();setCreating(true);setError(\"\");// Frontend validation\nif(!storyForm.title||storyForm.title.trim().length<10){setError(\"Story title must be at least 10 characters long\");setCreating(false);return;}if(!storyForm.content||storyForm.content.trim().length<100){setError(\"Story content must be at least 100 characters long\");setCreating(false);return;}if(storyForm.title.trim().length>150){setError(\"Story title cannot exceed 150 characters\");setCreating(false);return;}if(storyForm.content.trim().length>5000){setError(\"Story content cannot exceed 5000 characters\");setCreating(false);return;}try{let imageUrl=null;// Upload image if provided\nif(storyForm.image){setUploading(true);const formData=new FormData();formData.append(\"image\",storyForm.image);const uploadRes=await api.post(\"/upload/story-image\",formData,{headers:{\"Content-Type\":\"multipart/form-data\"}});if(!uploadRes.success)throw new Error(uploadRes.error||'Failed to upload image');imageUrl=uploadRes.data.imageUrl;setUploading(false);}const storyData={title:storyForm.title,content:storyForm.content,image:imageUrl};const res=await api.post(\"/stories\",storyData);if(!res.success)throw new Error(res.error||'Failed to create story');// Defensive: if res.data is an array, spread it; otherwise treat as single story\nif(Array.isArray(res.data)){setStories([...res.data,...stories]);}else{setStories([res.data,...stories]);}setShowCreateModal(false);setStoryForm({title:\"\",content:\"\",image:null});}catch(error){var _error$response,_error$response$data,_error$response2,_error$response2$data;console.error(\"Failed to create story:\",error);// Try to show detailed validation errors from backend\nif(error!==null&&error!==void 0&&(_error$response=error.response)!==null&&_error$response!==void 0&&(_error$response$data=_error$response.data)!==null&&_error$response$data!==void 0&&_error$response$data.errors){// Mongoose validation error array\nsetError(error.response.data.errors.map(err=>err.msg||err.message).join(\"; \"));}else if(error!==null&&error!==void 0&&(_error$response2=error.response)!==null&&_error$response2!==void 0&&(_error$response2$data=_error$response2.data)!==null&&_error$response2$data!==void 0&&_error$response2$data.message){setError(error.response.data.message);}else if(error.message){setError(error.message);}else{setError(\"Failed to share story. Please try again.\");}}finally{setCreating(false);setUploading(false);}};const handleLike=async storyId=>{try{const res=await api.post(\"/stories/\".concat(storyId,\"/like\"));if(!res.success)throw new Error(res.error||'Failed to like story');// Update the story in the list\nsetStories(stories.map(story=>story._id===storyId?_objectSpread(_objectSpread({},story),{},{likes:story.likes.includes(user._id)?story.likes.filter(id=>id!==user._id):[...story.likes,user._id]}):story));}catch(error){console.error(\"Failed to like story:\",error);}};const hasLiked=story=>{return story.likes.includes(user._id);};if(loading){return/*#__PURE__*/_jsx(LoadingSpinner,{text:\"Loading success stories...\"});}return/*#__PURE__*/_jsxs(\"div\",{className:\"max-w-4xl mx-auto\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between items-center mb-8\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"h1\",{className:\"text-3xl font-bold text-gray-900 dark:text-gray-100 mb-2\",children:\"Success Stories\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-600 dark:text-gray-400\",children:\"Share and celebrate alumni achievements\"})]}),/*#__PURE__*/_jsxs(\"button\",{onClick:()=>setShowCreateModal(true),className:\"btn-primary flex items-center\",children:[/*#__PURE__*/_jsx(PlusIcon,{className:\"h-4 w-4 mr-2\"}),\"Share Story\"]})]}),Array.isArray(stories)&&stories.length>0?/*#__PURE__*/_jsx(\"div\",{className:\"space-y-8\",children:stories.map(story=>{var _story$comments;return/*#__PURE__*/_jsxs(\"article\",{className:\"card p-6\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center mb-4\",children:[story.submittedBy&&story.submittedBy.profileImage?/*#__PURE__*/_jsx(\"img\",{src:story.submittedBy.profileImage||\"/placeholder.svg\",alt:story.submittedBy.name||'Unknown User',className:\"w-12 h-12 rounded-full object-cover\"}):/*#__PURE__*/_jsx(\"div\",{className:\"w-12 h-12 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center\",children:/*#__PURE__*/_jsx(\"span\",{className:\"text-lg font-bold text-gray-600 dark:text-gray-300\",children:story.submittedBy&&story.submittedBy.name?story.submittedBy.name.charAt(0).toUpperCase():'U'})}),/*#__PURE__*/_jsxs(\"div\",{className:\"ml-4\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"font-semibold text-gray-900 dark:text-gray-100\",children:story.submittedBy&&story.submittedBy.name?story.submittedBy.name:'Unknown User'}),/*#__PURE__*/_jsxs(\"p\",{className:\"text-sm text-gray-600 dark:text-gray-400\",children:[story.submittedBy&&story.submittedBy.batch?story.submittedBy.batch:'-',' â€¢ ',story.submittedBy&&story.submittedBy.branch?story.submittedBy.branch:'-']}),/*#__PURE__*/_jsx(\"p\",{className:\"text-xs text-gray-500 dark:text-gray-400\",children:new Date(story.createdAt).toLocaleDateString()})]})]}),/*#__PURE__*/_jsx(\"h2\",{className:\"text-xl font-bold text-gray-900 dark:text-gray-100 mb-4\",children:story.title}),story.image&&/*#__PURE__*/_jsx(\"div\",{className:\"mb-4\",children:/*#__PURE__*/_jsx(\"img\",{src:story.image||\"/placeholder.svg\",alt:story.title,className:\"w-full h-64 object-cover rounded-lg\"})}),/*#__PURE__*/_jsx(\"div\",{className:\"mb-6\",children:/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-700 dark:text-gray-300 whitespace-pre-wrap leading-relaxed\",children:story.content})}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-700\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-4\",children:[(user===null||user===void 0?void 0:user.role)===\"admin\"&&/*#__PURE__*/_jsx(\"button\",{onClick:async()=>{if(typeof window!=='undefined'&&window.confirm(\"Are you sure you want to delete this story? This cannot be undone.\")){try{const res=await api.delete(\"/stories/\".concat(story._id));if(!res.success)throw new Error(res.error||'Failed to delete story');setStories(stories.filter(s=>s._id!==story._id));}catch(err){var _err$response,_err$response$data;alert((err===null||err===void 0?void 0:(_err$response=err.response)===null||_err$response===void 0?void 0:(_err$response$data=_err$response.data)===null||_err$response$data===void 0?void 0:_err$response$data.message)||\"Failed to delete story.\");}}},className:\"text-red-600 hover:text-red-800 font-semibold px-2 py-1 border border-red-200 rounded\",children:\"Delete\"}),/*#__PURE__*/_jsxs(\"button\",{onClick:()=>handleLike(story._id),className:\"flex items-center space-x-2 px-3 py-2 rounded-lg transition-colors duration-200 \".concat(hasLiked(story)?\"text-red-600 bg-red-50 dark:bg-red-900/20\":\"text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700\"),children:[hasLiked(story)?/*#__PURE__*/_jsx(HeartIconSolid,{className:\"h-5 w-5\"}):/*#__PURE__*/_jsx(HeartIcon,{className:\"h-5 w-5\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"text-sm font-medium\",children:[story.likes.length,\" \",story.likes.length===1?\"like\":\"likes\"]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2 text-gray-600 dark:text-gray-400\",children:[/*#__PURE__*/_jsx(ChatBubbleLeftIcon,{className:\"h-5 w-5\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"text-sm\",children:[((_story$comments=story.comments)===null||_story$comments===void 0?void 0:_story$comments.length)||0,\" comments\"]})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"text-sm text-gray-500 dark:text-gray-400\",children:new Date(story.createdAt).toLocaleDateString()})]})]},story._id);})}):/*#__PURE__*/_jsxs(\"div\",{className:\"text-center py-12\",children:[/*#__PURE__*/_jsx(PhotoIcon,{className:\"mx-auto h-12 w-12 text-gray-400\"}),/*#__PURE__*/_jsx(\"h3\",{className:\"mt-2 text-sm font-medium text-gray-900 dark:text-gray-100\",children:\"No stories yet\"}),/*#__PURE__*/_jsx(\"p\",{className:\"mt-1 text-sm text-gray-500 dark:text-gray-400\",children:\"Be the first to share your success story!\"})]}),/*#__PURE__*/_jsxs(Modal,{isOpen:showCreateModal,onClose:()=>setShowCreateModal(false),title:\"Share Your Success Story\",size:\"lg\",children:[error&&/*#__PURE__*/_jsx(\"div\",{className:\"bg-red-100 text-red-700 px-4 py-2 rounded mb-2 border border-red-300\",children:error}),/*#__PURE__*/_jsxs(\"form\",{onSubmit:handleCreateStory,className:\"space-y-4\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{className:\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\",children:\"Story Title *\"}),/*#__PURE__*/_jsx(\"input\",{type:\"text\",name:\"title\",required:true,value:storyForm.title,onChange:handleStoryFormChange,className:\"input-field\",placeholder:\"e.g. From Student to CEO: My Journey\"})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{className:\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\",children:\"Your Story *\"}),/*#__PURE__*/_jsx(\"textarea\",{name:\"content\",required:true,rows:8,value:storyForm.content,onChange:handleStoryFormChange,className:\"input-field\",placeholder:\"Share your journey, challenges overcome, achievements, and advice for fellow alumni...\"})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{className:\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\",children:\"Add Image (Optional)\"}),/*#__PURE__*/_jsx(\"input\",{type:\"file\",name:\"image\",accept:\"image/*\",onChange:handleStoryFormChange,className:\"input-field\"}),storyForm.image&&/*#__PURE__*/_jsxs(\"p\",{className:\"mt-2 text-sm text-gray-600 dark:text-gray-400\",children:[\"Selected: \",storyForm.image.name]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-end space-x-4 pt-4\",children:[/*#__PURE__*/_jsx(\"button\",{type:\"button\",onClick:()=>setShowCreateModal(false),className:\"btn-secondary\",children:\"Cancel\"}),/*#__PURE__*/_jsx(\"button\",{type:\"submit\",disabled:creating||uploading,className:\"btn-primary disabled:opacity-50 disabled:cursor-not-allowed flex items-center\",children:creating||uploading?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"div\",{className:\"spinner mr-2\"}),uploading?\"Uploading...\":\"Sharing...\"]}):\"Share Story\"})]})]})]})]});};export default Stories;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}